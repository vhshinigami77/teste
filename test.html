<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Detector de Notas - Flauta Doce</title>

<style>
body { background:#111; color:#fff; font-family:Arial; text-align:center; padding:20px }
button { padding:10px 20px; margin:5px; font-size:16px }
.keyboards { display:flex; flex-direction:column; gap:20px }
.keyboard { display:flex; flex-wrap:wrap; justify-content:center; gap:4px }
.key { width:55px; height:70px; border-radius:6px; opacity:.2; display:flex; align-items:center; justify-content:center; font-weight:bold }

.C{background:#4fc3f7}.Csharp{background:#26a69a}.D{background:#66bb6a}
.Dsharp{background:#8bc34a}.E{background:#dce775;color:#000}
.F{background:#ffb74d}.Fsharp{background:#ff8a65}.G{background:#ef5350}
.Gsharp{background:#ba68c8}.A{background:#9575cd}.Asharp{background:#7986cb}.B{background:#64b5f6}

.note-display{margin-top:20px;font-size:28px}
#magnitudeBar{height:20px;background:#4caf50;width:0}
</style>
</head>

<body>

<h1>Detector de Notas – Flauta Doce</h1>

<button id="startBtn">Iniciar</button>
<button id="stopBtn" disabled>Parar</button>

<div class="keyboards">
  <div class="keyboard">
    <div class="key C" data-note="C5">C5</div>
    <div class="key D" data-note="D5">D5</div>
    <div class="key E" data-note="E5">E5</div>
    <div class="key F" data-note="F5">F5</div>
    <div class="key G" data-note="G5">G5</div>
    <div class="key A" data-note="A5">A5</div>
    <div class="key B" data-note="B5">B5</div>
  </div>

  <div class="keyboard">
    <div class="key C" data-note="C6">C6</div>
    <div class="key D" data-note="D6">D6</div>
    <div class="key E" data-note="E6">E6</div>
    <div class="key F" data-note="F6">F6</div>
    <div class="key G" data-note="G6">G6</div>
    <div class="key A" data-note="A6">A6</div>
    <div class="key B" data-note="B6">B6</div>
  </div>
</div>

<div class="note-display" id="noteDisplay">Nenhuma nota</div>
<div id="magnitudeBar"></div>

<script>
const API_URL = 'https://teste-fb8o.onrender.com/upload';
const BUFFER_SIZE = 2048;

let audioCtx, processor, mic, stream;
let buffer = [];
let running = false;

const keys = document.querySelectorAll('.key');
const noteDisplay = document.getElementById('noteDisplay');
const bar = document.getElementById('magnitudeBar');

function reset() {
  keys.forEach(k => k.style.opacity = .2);
  bar.style.width = '0';
}

function highlight(note, freq, mag) {
  reset();
  if (note === 'PAUSA') {
    noteDisplay.textContent = 'PAUSA';
    return;
  }
  const k = document.querySelector(`[data-note="${note}"]`);
  if (k) k.style.opacity = 1;
  noteDisplay.textContent = `${note} – ${freq.toFixed(1)} Hz`;
  bar.style.width = `${mag*100}%`;
}

async function send() {
  if (buffer.length < BUFFER_SIZE) return;
  const samples = buffer.splice(0, BUFFER_SIZE);

  const res = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ samples, sampleRate: audioCtx.sampleRate })
  });

  const data = await res.json();
  highlight(data.note, data.frequency, data.intensity);
}

async function start() {
  audioCtx = new AudioContext({ sampleRate:44100 });
  stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mic = audioCtx.createMediaStreamSource(stream);

  processor = audioCtx.createScriptProcessor(BUFFER_SIZE,1,1);
  processor.onaudioprocess = e => buffer.push(...e.inputBuffer.getChannelData(0));

  mic.connect(processor);
  processor.connect(audioCtx.destination);

  setInterval(send, 150);
}

startBtn.onclick = async () => {
  await start();
  running = true;
  startBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  running = false;
  processor.disconnect();
  mic.disconnect();
  stream.getTracks().forEach(t=>t.stop());
  audioCtx.close();
  reset();
  noteDisplay.textContent = 'Nenhuma nota';
};
</script>

</body>
</html>
