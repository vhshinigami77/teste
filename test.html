<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gravação contínua e análise de áudio</title>
</head>
<body>
  <h1>Gravação contínua e análise de áudio</h1>

  <button id="startBtn">Iniciar</button>
  <button id="stopBtn" disabled>Parar</button>

  <p>Status: <span id="status">Pronto para gravar</span></p>
  <p>Nota atual: <span id="nota">-</span></p>

  <script>
    let mediaRecorder;
    let isRecording = false;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusSpan = document.getElementById('status');
    const notaSpan = document.getElementById('nota');

    // Envia o áudio para o backend e atualiza a nota
    async function enviarAudio(blob) {
      statusSpan.textContent = 'Enviando áudio para análise...';

      const formData = new FormData();
      formData.append('audio', blob, 'audio.webm');

      try {
        const response = await fetch('https://teste-fb8o.onrender.com/upload', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();

        notaSpan.textContent = data.dominantNote || 'Não detectada';
        statusSpan.textContent = 'Análise concluída!';
      } catch (err) {
        statusSpan.textContent = 'Erro na análise.';
        console.error(err);
      }
    }

    async function iniciarGravacao() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = async (event) => {
          if (event.data && event.data.size > 0) {
            await enviarAudio(event.data);
            if (isRecording) {
              mediaRecorder.start(1000);
            }
          }
        };

        isRecording = true;
        statusSpan.textContent = 'Gravando...';
        notaSpan.textContent = '-';
        startBtn.disabled = true;
        stopBtn.disabled = false;

        mediaRecorder.start(1000);
      } catch (err) {
        alert('Erro ao acessar o microfone.');
        console.error(err);
      }
    }

    function pararGravacao() {
      if (mediaRecorder && isRecording) {
        isRecording = false;
        mediaRecorder.stop();
        statusSpan.textContent = 'Gravação parada.';
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    startBtn.onclick = iniciarGravacao;
    stopBtn.onclick = pararGravacao;
  </script>
</body>
</html>
