<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>TCC Victor - Detector de Notas - Flauta Doce</title>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial;
  text-align:center;
}
button {
  padding:10px 20px;
  font-size:16px;
  margin:5px;
}
.key {
  width:55px;
  height:70px;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  opacity:.2;
  transition:.2s;
}
.keyboard {
  display:flex;
  gap:4px;
  justify-content:center;
  margin:10px;
}
.note-display {
  margin:20px;
  font-size:26px;
}
</style>
</head>

<body>

<h1>Detector de Notas – Flauta Doce</h1>

<button id="startBtn">Iniciar</button>
<button id="stopBtn" disabled>Parar</button>

<div class="keyboard">
  <div class="key" data-note="C5">C5</div>
  <div class="key" data-note="D5">D5</div>
  <div class="key" data-note="E5">E5</div>
  <div class="key" data-note="F5">F5</div>
  <div class="key" data-note="G5">G5</div>
  <div class="key" data-note="A5">A5</div>
  <div class="key" data-note="B5">B5</div>
</div>

<div class="note-display" id="noteDisplay">---</div>

<script>
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const noteDisplay = document.getElementById('noteDisplay');
const keys = document.querySelectorAll('.key');

let audioCtx, processor, mic, stream;
let isRunning = false;

const BUFFER_SIZE = 2048;

function resetKeys() {
  keys.forEach(k => k.style.opacity = .2);
}

function highlight(note, freq, intensity) {
  resetKeys();
  if (note === 'PAUSA') {
    noteDisplay.textContent = 'PAUSA';
    return;
  }
  const el = document.querySelector(`[data-note="${note}"]`);
  if (el) el.style.opacity = 1;
  noteDisplay.textContent = `${note} – ${freq.toFixed(1)} Hz`;
}

async function startAudio() {
  audioCtx = new AudioContext({ sampleRate: 44100 });
  stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mic = audioCtx.createMediaStreamSource(stream);

  processor = audioCtx.createScriptProcessor(BUFFER_SIZE, 1, 1);

  processor.onaudioprocess = async e => {
    if (!isRunning) return;

    const input = e.inputBuffer.getChannelData(0);
    const samples = Array.from(input);

    const res = await fetch('http://localhost:3000/upload', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        samples,
        sampleRate: audioCtx.sampleRate
      })
    });

    const data = await res.json();
    highlight(data.note, data.frequency, data.intensity);
  };

  mic.connect(processor);
  processor.connect(audioCtx.destination);
}

startBtn.onclick = async () => {
  await startAudio();
  isRunning = true;
  startBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  isRunning = false;
  processor.disconnect();
  mic.disconnect();
  stream.getTracks().forEach(t => t.stop());
  audioCtx.close();
  resetKeys();
  startBtn.disabled = false;
  stopBtn.disabled = true;
};
</script>

</body>
</html>
