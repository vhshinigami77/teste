<script>
let mediaRecorder;
let isRunning = false;
let intervalId = null;
let uploadQueue = []; // fila de blobs para envio

startBtn.onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    isRunning = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    statusP.textContent = 'Gravando continuamente...';

    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0 && isRunning) {
        uploadQueue.push(e.data); // adiciona o chunk na fila
      }
    };

    mediaRecorder.start();

    // Captura um pedaço a cada 1 segundo
    intervalId = setInterval(() => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.requestData();
      }
    }, 1000);

    // Inicia o loop de envio da fila (assíncrono, não trava a gravação)
    processQueue();

  } catch (err) {
    alert('Erro ao acessar o microfone.');
    console.error(err);
  }
};

stopBtn.onclick = () => {
  isRunning = false;
  clearInterval(intervalId);
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  startBtn.disabled = false;
  stopBtn.disabled = true;
  statusP.textContent = 'Processo finalizado.';
};

async function processQueue() {
  while (isRunning) {
    if (uploadQueue.length > 0) {
      const blob = uploadQueue.shift(); // pega o primeiro blob da fila
      await enviarChunk(blob); // envia e espera a resposta
    } else {
      // espera um pouco antes de checar de novo
      await new Promise(res => setTimeout(res, 50));
    }
  }
}

async function enviarChunk(blob) {
  const formData = new FormData();
  formData.append('audio', blob, 'chunk.webm');

  try {
    const response = await fetch('https://teste-fb8o.onrender.com/upload', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();

    notaSpan.textContent = data.dominantNote || 'Não detectada';
    freqSpan.textContent = data.dominantFrequency ? data.dominantFrequency.toFixed(2) : '-';

    detalhes.textContent = `
dominantFrequency: ${data.dominantFrequency?.toFixed(2) ?? '-'} Hz
dominantNote: ${data.dominantNote ?? '-'}
    `.trim();

  } catch (err) {
    console.error('Erro no envio/análise:', err);
  }
}
</script>
