<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Detector de Notas</title>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
  }

  button {
    margin: 5px;
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    opacity: 0.3;
    transition: opacity 0.3s ease;
  }
  button:enabled { opacity: 1; }
  #startBtn { background: #4caf50; color: white; }
  #stopBtn { background: #f44336; color: white; }

  .keyboards {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 30px auto;
    max-width: 1000px;
  }
  .keyboard {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 4px;
  }
  .key {
    width: 55px;
    height: 70px;
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 13px;
    opacity: 0.2;
    transition: all 0.3s ease;
    text-align: center;
  }
  .active { opacity: 1; box-shadow: 0 0 20px #fff; transform: scale(1.1); }

  .note-display {
    margin-top: 20px;
    font-size: 28px;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 10px;
    background: #222;
    display: inline-block;
    box-shadow: 0 0 10px #000;
    transition: background 0.3s ease;
  }

  #magnitudeDisplay {
    margin-top: 10px;
    font-size: 20px;
  }
</style>
</head>
<body>

<button id="startBtn">Iniciar</button>
<button id="stopBtn" disabled>Parar</button>

<div class="keyboards">
  <div class="keyboard" id="octave4"></div>
  <div class="keyboard" id="octave5"></div>
</div>

<div class="note-display" id="noteDisplay">Nenhuma nota</div>
<div id="magnitudeDisplay">Magnitude: -</div>

<script>
const keys = {};
const noteDisplay = document.getElementById("noteDisplay");
const magnitudeDisplay = document.getElementById("magnitudeDisplay");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

const octaves = [4,5];
const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

// ======== Criar teclas ========
octaves.forEach(oct => {
  const container = document.getElementById(`octave${oct}`);
  noteNames.forEach(note => {
    const key = document.createElement("div");
    key.className = "key " + note.replace("#","sharp");
    key.dataset.note = note + oct;
    key.textContent = note + oct;
    container.appendChild(key);
    keys[note + oct] = key;
  });
});

// ======== Estado de gravação ========
let mediaRecorder, stream, isRecording = false;
function delay(ms){ return new Promise(r => setTimeout(r, ms)); }
function resetKeys(){ Object.values(keys).forEach(k => k.classList.remove("active")); }

// ======== Atualiza teclado e display ========
function highlightNote(note, magnitude, level){
  resetKeys();

  if(!note || note === "PAUSA"){
    noteDisplay.textContent = "PAUSA";
    noteDisplay.style.background = "#222";
  } else {
    const keyEl = keys[note];
    if(keyEl) keyEl.classList.add("active");
    noteDisplay.textContent = note;
  }

  magnitudeDisplay.textContent = "Magnitude: " + Math.round(magnitude*100)/100;

  // Ajuste de cores de acordo com nível
  if(level === "low") {
    noteDisplay.style.background = "#333";
    magnitudeDisplay.style.color = "#aaa";
  } else if(level === "medium") {
    noteDisplay.style.background = "#555";
    magnitudeDisplay.style.color = "#ffa500";
  } else {
    noteDisplay.style.background = "#f00";
    magnitudeDisplay.style.color = "#f00";
  }
}

// ======== Enviar áudio para backend ========
async function enviarAudio(blob){
  const formData = new FormData();
  formData.append("audio", blob, "audio.webm");

  try {
    const res = await fetch("https://teste-fb8o.onrender.com/upload", { method:"POST", body: formData });
    const data = await res.json();
    highlightNote(data.dominantNote, data.magnitude, data.level);
  } catch(err){
    console.error(err);
    noteDisplay.textContent = "Erro";
    noteDisplay.style.background = "#222";
    magnitudeDisplay.textContent = "-";
  }
}

// ======== Gravação contínua ========
async function gravarEProcessar(){
  while(isRecording){
    mediaRecorder.start();
    const audioBlob = await new Promise(resolve => {
      mediaRecorder.ondataavailable = e => resolve(e.data);
      setTimeout(() => mediaRecorder.stop(), 1000);
    });
    await enviarAudio(audioBlob);
    await delay(1000);
  }
}

// ======== Botões ========
startBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRecorder = new MediaRecorder(stream);
    isRecording = true;

    startBtn.disabled = true;
    stopBtn.disabled = false;
    noteDisplay.textContent = "Gravando...";
    noteDisplay.style.background = "#222";
    magnitudeDisplay.textContent = "-";

    gravarEProcessar();
  } catch(err){
    alert("Erro ao acessar microfone");
    console.error(err);
  }
};

stopBtn.onclick = () => {
  isRecording = false;
  if(mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
  if(stream) stream.getTracks().forEach(t => t.stop());

  startBtn.disabled = false;
  stopBtn.disabled = true;
  noteDisplay.textContent = "Gravação parada";
  noteDisplay.style.background = "#222";
  magnitudeDisplay.textContent = "-";
  resetKeys();
};
</script>

</body>
</html>
