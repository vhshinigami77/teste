<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gravador de Áudio</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Gravar Áudio em 44kHz</h1>
  <button id="record">Gravar</button>
  <button id="stop" disabled>Parar</button>
  <p id="status"></p>

  <audio id="audio" controls style="display: none;"></audio>
  <div id="download"></div>
  <canvas id="chart" width="600" height="300"></canvas>

  <script>
    let audioContext;
    let processor;
    let input;
    let globalStream;
    let recorded = [];

    const recordBtn = document.getElementById('record');
    const stopBtn = document.getElementById('stop');
    const status = document.getElementById('status');
    const downloadDiv = document.getElementById('download');
    const audioElement = document.getElementById('audio');

    recordBtn.onclick = async () => {
      globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContext = new AudioContext({ sampleRate: 44100 });
      const source = audioContext.createMediaStreamSource(globalStream);
      processor = audioContext.createScriptProcessor(4096, 1, 1);

      recorded = [];

      processor.onaudioprocess = (e) => {
        recorded.push(new Float32Array(e.inputBuffer.getChannelData(0)));
      };

      source.connect(processor);
      processor.connect(audioContext.destination);

      status.textContent = "Gravando em 44 kHz...";
      recordBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = async () => {
      processor.disconnect();
      globalStream.getTracks().forEach(track => track.stop());

      const blob = encodeWAV(recorded, 44100);
      const audioUrl = URL.createObjectURL(blob);
      audioElement.src = audioUrl;
      audioElement.style.display = 'block';

      status.textContent = "Gravação finalizada. Enviando...";

      const formData = new FormData();
      formData.append('audio', blob, 'gravacao.wav');

      try {
        const response = await fetch('https://teste-fb8o.onrender.com/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error("Erro ao enviar");

        const json = await response.json();

        status.textContent = "Processamento concluído!";
        downloadDiv.innerHTML = `<a href="https://teste-fb8o.onrender.com${json.downloadUrl}" target="_blank">Baixar TXT</a>`;

        drawChart(json.samples);

      } catch (err) {
        status.textContent = "Erro ao enviar: " + err.message;
      }

      recordBtn.disabled = false;
      stopBtn.disabled = true;
    };

    function encodeWAV(buffers, sampleRate) {
      const flat = Float32Array.from(buffers.flat());
      const length = flat.length;
      const buffer = new ArrayBuffer(44 + length * 2);
      const view = new DataView(buffer);

      const writeString = (offset, str) => {
        for (let i = 0; i < str.length; i++) {
          view.setUint8(offset + i, str.charCodeAt(i));
        }
      };

      writeString(0, 'RIFF');
      view.setUint32(4, 36 + length * 2, true);
      writeString(8, 'WAVE');
      writeString(12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, 1, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true);
      view.setUint16(34, 16, true);
      writeString(36, 'data');
      view.setUint32(40, length * 2, true);

      for (let i = 0; i < length; i++) {
        const s = Math.max(-1, Math.min(1, flat[i]));
        view.setInt16(44 + i * 2, s * 32767, true);
      }

      return new Blob([view], { type: 'audio/wav' });
    }

    function drawChart(samples) {
      const times = samples.map(s => parseFloat(s.time));
      const amplitudes = samples.map(s => parseFloat(s.amplitude));

      new Chart(document.getElementById('chart'), {
        type: 'line',
        data: {
          labels: times,
          datasets: [{
            label: 'Amplitude',
            data: amplitudes,
            borderColor: 'blue',
            borderWidth: 1,
            pointRadius: 0
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Tempo (s)' }, type: 'linear' },
            y: { title: { display: true, text: 'Amplitude' } }
          },
          plugins: { legend: { display: false } },
          elements: { line: { tension: 0 } }
        }
      });
    }
  </script>
</body>
</html>
